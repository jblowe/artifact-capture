<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/app.css') }}">
  <script defer src="{{ url_for('static', filename='js/app.js') }}"></script>
  <title>Recent</title>
</head>
<body>
{% include "_banner.html" %}

<div class="page">
  <div class="card">
    <div class="tabs">
      {% for k, m in OBJECT_TYPES.items() %}
        <a class="tab {% if k == otype %}active{% endif %}" href="{{ url_for('recent', type=k, view=view) }}">{{ m.label }}</a>
      {% endfor %}
    </div>

    <div class="actions" style="justify-content:flex-start; margin-top:10px;">
      <a class="btn {% if view == 'para' %}primary{% endif %}" href="{{ url_for('recent', type=otype, view='para') }}">Cards</a>
      <a class="btn {% if view == 'table' %}primary{% endif %}" href="{{ url_for('recent', type=otype, view='table') }}">Table</a>
    </div>

    {% if view == 'table' %}
      <div style="overflow:auto; margin-top:10px;">
        <table class="grid-table">
          <thead>
            <tr>
              <th>ID</th>
              {% for col in meta.result_fields %}
                {% set fm = meta.field_meta.get(col, {}) %}
                <th>{{ fm.get('label') or col }}</th>
              {% endfor %}
              <th>Images</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              {% set images = (r['images_json']|fromjson) %}
              <tr>
                <td class="mono">{{ r['id'] }}</td>
                {% for col in meta.result_fields %}
                  <td>{{ r[col] }}</td>
                {% endfor %}
                <td class="mono">{{ (images|length) if images else 0 }}</td>
                <td class="mono">{{ r['date_updated'] or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    {% else %}
      {% for r in rows %}
        {% set images = (r['images_json']|fromjson) %}
        {% set thumbs = (r['thumbs_json']|fromjson) %}
        <div class="card" style="margin-top:12px;">
          <div class="row" style="align-items:flex-start; gap:14px;">
            <div style="min-width:120px;">
              {% if thumbs and thumbs[-1] %}
                <a href="{{ url_for('serve_upload', fname=images[-1] if images else thumbs[-1]) }}" target="_blank">
                  <img class="thumb" src="{{ url_for('serve_upload', fname=thumbs[-1]) }}" alt="thumb">
                </a>
              {% endif %}
              <div class="small">ID: <span class="mono">{{ r['id'] }}</span></div>
              {% if images %}<div class="small">Images: {{ images|length }}</div>{% endif %}
            </div>

            <div class="small" style="flex:1;">
              {% for row in meta.result_rows %}
                <div>
                  {% for col in row %}
                    {% set fm = meta.field_meta.get(col, {}) %}
                    {% if r[col] %}
                      <strong>{{ fm.get('label') or col }}:</strong> {{ r[col] }}
                      {% if not loop.last %} Â· {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% endfor %}
              {% if r['date_updated'] %}<div class="meta">Updated: {{ r['date_updated'] }}</div>{% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}

  </div>
</div>

</body>
</html>
