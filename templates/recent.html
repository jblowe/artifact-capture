<!doctype html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="{{ url_for('static', filename='styles/app.css') }}">
<script defer src="{{ url_for('static', filename='js/app.js') }}"></script>
<title>Recent uploads</title>

<body>
{% include "_banner.html" %}
<div class="page">


  <div class="tabs">
    {% for k, m in OBJECT_TYPES.items() %}
      <a class="tab {% if k == otype %}active{% endif %}" href="{{ url_for('recent', type=k) }}">{{ m.label }}</a>
    {% endfor %}
  </div>


  <table>
    <thead>
      <tr>
        <th>ID</th><th>Image</th><th>Fields</th><th>GPS</th><th>Files</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      {% set thumbs = (r['thumbs_json']|fromjson) %}
      {% set images = (r['images_json']|fromjson) %}
      {% set jfiles = (r['json_files_json']|fromjson) %}
      <tr>
        <td>{{ r['id'] }}</td>
        <td>
          {% if thumbs %}
            {% set total = thumbs|length %}
            {% set show = thumbs[(total-2) if total>2 else 0:] %}
            {% set start = total - (show|length) %}
            <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
              {% for t in show %}
                {% set i = start + loop.index0 %}
                {% if images and (images|length > i) and images[i] %}
                  {% set href = url_for('serve_upload', fname=images[i]) %}
                {% else %}
                  {% set href = url_for('serve_upload', fname=t) %}
                {% endif %}
                <a href="{{ href }}" target="_blank"><img class="thumb" src="{{ url_for('serve_upload', fname=t) }}" alt=""></a>
              {% endfor %}
            </div>
          {% elif images and images[-1] %}
            <a href="{{ url_for('serve_upload', fname=images[-1]) }}" target="_blank"><img class="thumb" src="{{ url_for('serve_upload', fname=images[-1]) }}" alt=""></a>
          {% endif %}
          {% if images %}<div class="small">{{ images|length }} image(s)</div>{% endif %}
        </td>
        <td class="small">
          {% if r['date_recorded'] %}<strong>Date recorded:</strong> {{ r['date_recorded'] }}<br>{% endif %}
          {% for col in meta.required_fields %}
            {% if r[col] %}<strong>{{ meta.field_meta[col].label }}:</strong> {{ r[col] }}<br>{% endif %}
          {% endfor %}
        </td>
        <td class="small">
          {% if r['gps_lat'] and r['gps_lon'] %}
            {{ "%.6f"|format(r['gps_lat']) }}, {{ "%.6f"|format(r['gps_lon']) }}<br>
            {% set osm, gmaps = maps_links(r['gps_lat'], r['gps_lon']) %}
            <a class="btn" href="{{ osm }}" target="_blank">OSM</a>
            <a class="btn" href="{{ gmaps }}" target="_blank">Maps</a>
          {% else %}
            â€”
          {% endif %}
        </td>
        <td class="small">
          {% if images %}
            {% if images|length == 1 %}
              <a class="btn" href="{{ url_for('serve_upload', fname=images[0]) }}" target="_blank">JPEG</a>
            {% else %}
              <a class="btn" href="{{ url_for('admin_record_images', otype=otype, aid=r['id']) }}" target="_blank">JPEG</a>
            {% endif %}
          {% endif %}
          {% if jfiles and jfiles[-1] %}<a class="btn" href="{{ url_for('serve_upload', fname=jfiles[-1]) }}" target="_blank">JSON</a>{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
</body>
</html>
