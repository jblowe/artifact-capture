<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/app.css') }}">
  <script defer src="{{ url_for('static', filename='js/app.js') }}"></script>
  <title>Recent</title>
</head>
<body>
{% include "_banner.html" %}

<div class="page">
  <div class="card">
    <div class="tabs">
      {% for k, m in OBJECT_TYPES.items() %}
        <a class="tab {% if k == otype %}active{% endif %}" href="{{ url_for('recent', type=k, view=view) }}">{{ m.label }}</a>
      {% endfor %}
    </div>

    <div class="actions" style="justify-content:flex-start; margin-top:10px;">
      <a class="btn {% if view == 'para' %}primary{% endif %}" href="{{ url_for('recent', type=otype, view='para') }}">Cards</a>
      <a class="btn {% if view == 'table' %}primary{% endif %}" href="{{ url_for('recent', type=otype, view='table') }}">Table</a>
    </div>

    {% if view == 'table' %}
      <div style="overflow:auto; margin-top:10px;">
        <table class="grid-table">
          <thead>
            <tr>
              <th>ID</th>
              {% for col in meta.result_fields %}
                {% set fm = meta.field_meta.get(col, {}) %}
                <th>{{ fm.get('label') or col }}</th>
              {% endfor %}
              <th>Updated</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td class="mono"><strong>{{ r['id'] }}</strong></td>
                {% for col in meta.result_fields %}
                  <td>{{ r[col] }}</td>
                {% endfor %}
                <td class="mono">{{ r['date_updated'] or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    {% else %}
      {% for r in rows %}
        {% set images = (r['images_json']|fromjson) %}
        {% set thumbs = (r['thumbs_json']|fromjson) %}
        <div class="card" style="margin-top:12px;">
          <div style="font-weight:800; margin-bottom:8px;"><strong>{{ r['id'] }}</strong></div>
          <div style="display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;">

            <!-- Left: metadata -->
            <div style="flex:1 1 360px; min-width:280px;">
              <table class="result-table compact-table" style="width:100%;">
                {% for row in meta.result_rows %}
                  {% for col in row %}
                    {% set fm = meta.field_meta.get(col, {}) %}
                    {% set val = r[col] if r[col] is not none else '' %}
                    {% if val %}
                      <tr>
                        <td class="label" style="width:35%;">{{ fm.get('label') or col }}</td>
                        <td>{{ val }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              </table>
              {% if r['date_updated'] %}<div class="meta" style="margin-top:6px;">Updated: {{ r['date_updated'] }}</div>{% endif %}
            </div>

            <!-- Right: images -->
            <div style="flex:0 0 320px; min-width:240px;">
              {% if thumbs %}
                <div style="display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-start;">
                  {% for t in thumbs %}
                    {% set i = loop.index0 %}
                    {% set href = (images[i] if images and (images|length > i) else t) %}
                    <a href="{{ url_for('serve_upload', fname=href) }}" target="_blank" title="{{ href }}">
                      <img class="thumb" src="{{ url_for('serve_upload', fname=t) }}" alt="thumb">
                    </a>
                  {% endfor %}
                </div>
              {% elif images %}
                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                  {% for img in images %}
                    <a href="{{ url_for('serve_upload', fname=img) }}" target="_blank" title="{{ img }}">
                      <img class="thumb" src="{{ url_for('serve_upload', fname=img) }}" alt="image">
                    </a>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

          </div>
        </div>
      {% endfor %}
    {% endif %}

  </div>
</div>

</body>
</html>
